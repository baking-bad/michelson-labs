<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Chapter 14 | Michelson Labs</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon.png">
    <meta name="description" content="All the use cases we have explored so far follow a very simple flow: a transaction hits the smart contract, the parameter sent with the transaction and the storage are pushed as a pair onto the stack, the code of the contract manipulates the stack with or without the help of environment variables and a pair containing a list of transactions (that was until now empty) and the new storage is returned.">
    <meta name="image" content="https://michelson.baking-bad.org/og.png">
    <meta name="twitter:title" content="Chapter 14">
    <meta name="twitter:description" content="All the use cases we have explored so far follow a very simple flow: a transaction hits the smart contract, the parameter sent with the transaction and the storage are pushed as a pair onto the stack, the code of the contract manipulates the stack with or without the help of environment variables and a pair containing a list of transactions (that was until now empty) and the new storage is returned.">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://michelson.baking-bad.org/og.png">
    <meta name="twitter:url" content="https://michelson.baking-bad.org/chapters/14.html">
    <meta name="twitter:site" content="@TezosBakingBad">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Chapter 14">
    <meta property="og:description" content="All the use cases we have explored so far follow a very simple flow: a transaction hits the smart contract, the parameter sent with the transaction and the storage are pushed as a pair onto the stack, the code of the contract manipulates the stack with or without the help of environment variables and a pair containing a list of transactions (that was until now empty) and the new storage is returned.">
    <meta property="og:image" content="https://michelson.baking-bad.org/og.png">
    <meta property="og:url" content="https://michelson.baking-bad.org/chapters/14.html">
    <meta property="og:site_name" content="Michelson Labs">
    <meta itemprop="name" content="Chapter 14">
    <meta itemprop="description" content="All the use cases we have explored so far follow a very simple flow: a transaction hits the smart contract, the parameter sent with the transaction and the storage are pushed as a pair onto the stack, the code of the contract manipulates the stack with or without the help of environment variables and a pair containing a list of transactions (that was until now empty) and the new storage is returned.">
    <meta itemprop="image" content="https://michelson.baking-bad.org/og.png">
    <link rel="preload" href="/assets/css/0.styles.41c7ef0c.css" as="style"><link rel="preload" href="/assets/js/app.18800d3b.js" as="script"><link rel="preload" href="/assets/js/2.430b66b2.js" as="script"><link rel="preload" href="/assets/js/23.cfbbd282.js" as="script"><link rel="preload" href="/assets/js/4.c279c943.js" as="script"><link rel="preload" href="/assets/js/3.550cb5aa.js" as="script"><link rel="prefetch" href="/assets/js/10.39ae3c42.js"><link rel="prefetch" href="/assets/js/11.897dacfb.js"><link rel="prefetch" href="/assets/js/12.083d37d3.js"><link rel="prefetch" href="/assets/js/13.a75e832a.js"><link rel="prefetch" href="/assets/js/14.d7e9078d.js"><link rel="prefetch" href="/assets/js/15.2d0a9cd5.js"><link rel="prefetch" href="/assets/js/16.5316cf4d.js"><link rel="prefetch" href="/assets/js/17.f4089664.js"><link rel="prefetch" href="/assets/js/18.bc1d5da2.js"><link rel="prefetch" href="/assets/js/19.2f489976.js"><link rel="prefetch" href="/assets/js/20.d6a0692d.js"><link rel="prefetch" href="/assets/js/21.2bcbd1eb.js"><link rel="prefetch" href="/assets/js/22.42b58ecc.js"><link rel="prefetch" href="/assets/js/24.3069e4b3.js"><link rel="prefetch" href="/assets/js/25.9bb53cdf.js"><link rel="prefetch" href="/assets/js/5.b2436255.js"><link rel="prefetch" href="/assets/js/6.c09f7c7f.js"><link rel="prefetch" href="/assets/js/7.16d6fa11.js"><link rel="prefetch" href="/assets/js/8.c7c848cc.js"><link rel="prefetch" href="/assets/js/9.d1dbceb8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.41c7ef0c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo_small.png" alt="Michelson Labs" class="logo"> <span class="site-name can-hide">Michelson Labs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/learn.html" class="nav-link">
  Learn
</a></div><div class="nav-item"><a href="/introduction.html" class="nav-link">
  Notebooks 
</a></div><div class="nav-item"><a href="https://baking-bad.org/docs" target="_blank" rel="noopener noreferrer" class="nav-link external">
  About
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/learn.html" class="nav-link">
  Learn
</a></div><div class="nav-item"><a href="/introduction.html" class="nav-link">
  Notebooks 
</a></div><div class="nav-item"><a href="https://baking-bad.org/docs" target="_blank" rel="noopener noreferrer" class="nav-link external">
  About
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/learn.html" class="sidebar-link">Learn Michelson</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn.html#why-🤔" class="sidebar-link">Why 🤔</a></li><li class="sidebar-sub-header"><a href="/learn.html#how" class="sidebar-link">How</a></li><li class="sidebar-sub-header"><a href="/learn.html#resources" class="sidebar-link">Resources</a></li><li class="sidebar-sub-header"><a href="/learn.html#contact-us" class="sidebar-link">Contact us</a></li><li class="sidebar-sub-header"><a href="/learn.html#about" class="sidebar-link">About</a></li></ul></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Notebooks</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/introduction.html" class="sidebar-link">Introduction</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/introduction.html#try-online" class="sidebar-link">Try online</a></li><li class="sidebar-sub-header"><a href="/introduction.html#run-in-docker" class="sidebar-link">Run in Docker</a></li><li class="sidebar-sub-header"><a href="/introduction.html#install-jupyter" class="sidebar-link">Install Jupyter</a></li><li class="sidebar-sub-header"><a href="/introduction.html#notebook-workflow" class="sidebar-link">Notebook workflow</a></li></ul></li><li><a href="/chapters/01.html" class="sidebar-link">Chapter 1</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapters/01.html#understanding-the-stack" class="sidebar-link">Understanding the stack</a></li><li class="sidebar-sub-header"><a href="/chapters/01.html#structure-of-a-smart-contract" class="sidebar-link">Structure of a Smart Contract</a></li><li class="sidebar-sub-header"><a href="/chapters/01.html#operation-codes" class="sidebar-link">Operation codes</a></li><li class="sidebar-sub-header"><a href="/chapters/01.html#running-the-contract-step-by-step" class="sidebar-link">Running the contract step-by-step</a></li></ul></li><li><a href="/chapters/02.html" class="sidebar-link">Chapter 2</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapters/02.html#types-in-michelson" class="sidebar-link">Types in Michelson</a></li><li class="sidebar-sub-header"><a href="/chapters/02.html#advanced-stack-usage" class="sidebar-link">Advanced stack usage</a></li></ul></li><li><a href="/chapters/03.html" class="sidebar-link">Chapter 3</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapters/03.html#compare-and-generic-comparisons" class="sidebar-link">Compare and generic comparisons</a></li><li class="sidebar-sub-header"><a href="/chapters/03.html#conditionals" class="sidebar-link">Conditionals</a></li><li class="sidebar-sub-header"><a href="/chapters/03.html#fail-and-assert" class="sidebar-link">FAIL and ASSERT</a></li><li class="sidebar-sub-header"><a href="/chapters/03.html#recap" class="sidebar-link">Recap</a></li></ul></li><li><a href="/chapters/04.html" class="sidebar-link">Chapter 4</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapters/04.html#available-types-for-arithmetic-operations" class="sidebar-link">Available types for arithmetic operations</a></li><li class="sidebar-sub-header"><a href="/chapters/04.html#the-add-instruction" class="sidebar-link">The `ADD` instruction</a></li><li class="sidebar-sub-header"><a href="/chapters/04.html#the-sub-instruction" class="sidebar-link">The `SUB` instruction</a></li><li class="sidebar-sub-header"><a href="/chapters/04.html#the-mul-instruction" class="sidebar-link">The `MUL` instruction</a></li><li class="sidebar-sub-header"><a href="/chapters/04.html#the-ediv-instruction" class="sidebar-link">The `EDIV` instruction</a></li><li class="sidebar-sub-header"><a href="/chapters/04.html#other-operations-on-numeric-values" class="sidebar-link">Other operations on numeric values</a></li></ul></li><li><a href="/chapters/05.html" class="sidebar-link">Chapter 5</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapters/05.html#mutez-and-mutez-operations" class="sidebar-link">mutez and mutez operations</a></li><li class="sidebar-sub-header"><a href="/chapters/05.html#balance-amount-and-now" class="sidebar-link">`BALANCE`, `AMOUNT` and `NOW`</a></li><li class="sidebar-sub-header"><a href="/chapters/05.html#address-contract-and-token-transfer" class="sidebar-link">Address, contract and token transfer</a></li></ul></li><li><a href="/chapters/06.html" class="sidebar-link">Chapter 6</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapters/06.html#boolean-type-and-operations-on-booleans" class="sidebar-link">Boolean type and operations on booleans</a></li><li class="sidebar-sub-header"><a href="/chapters/06.html#cryptographic-operations" class="sidebar-link">Cryptographic operations</a></li></ul></li><li><a href="/chapters/07.html" class="sidebar-link">Chapter 7</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapters/07.html#strings-and-string-manipulations" class="sidebar-link">Strings and string manipulations</a></li><li class="sidebar-sub-header"><a href="/chapters/07.html#working-with-lists" class="sidebar-link">Working with lists</a></li></ul></li><li><a href="/chapters/08.html" class="sidebar-link">Chapter 8</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapters/08.html#overview-of-the-pair-type" class="sidebar-link">Overview of the pair type</a></li><li class="sidebar-sub-header"><a href="/chapters/08.html#operations-on-pairs" class="sidebar-link">Operations on pairs</a></li><li class="sidebar-sub-header"><a href="/chapters/08.html#pairing-and-unpairing" class="sidebar-link">Pairing and unpairing</a></li></ul></li><li><a href="/chapters/09.html" class="sidebar-link">Chapter 9</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapters/09.html#casting-types" class="sidebar-link">Casting types</a></li><li class="sidebar-sub-header"><a href="/chapters/09.html#working-with-bytes" class="sidebar-link">Working with bytes</a></li></ul></li><li><a href="/chapters/10.html" class="sidebar-link">Chapter 10</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapters/10.html#working-with-sets" class="sidebar-link">Working with sets</a></li><li class="sidebar-sub-header"><a href="/chapters/10.html#working-with-maps" class="sidebar-link">Working with maps</a></li></ul></li><li><a href="/chapters/11.html" class="sidebar-link">Chapter 11</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapters/11.html#the-loop-instruction" class="sidebar-link">The `LOOP` instruction</a></li><li class="sidebar-sub-header"><a href="/chapters/11.html#iterating-on-sets" class="sidebar-link">Iterating on sets</a></li><li class="sidebar-sub-header"><a href="/chapters/11.html#iterating-on-maps" class="sidebar-link">Iterating on maps</a></li></ul></li><li><a href="/chapters/12.html" class="sidebar-link">Chapter 12</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapters/12.html#union-types-and-entrypoints" class="sidebar-link">Union types and entrypoints</a></li></ul></li><li><a href="/chapters/13.html" class="sidebar-link">Chapter 13</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapters/13.html#address-and-contract-types" class="sidebar-link">Address and contract types</a></li><li class="sidebar-sub-header"><a href="/chapters/13.html#self-source-and-sender" class="sidebar-link">SELF, SOURCE and SENDER</a></li></ul></li><li><a href="/chapters/14.html" aria-current="page" class="active sidebar-link">Chapter 14</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapters/14.html#creating-and-sending-transactions" class="sidebar-link">Creating and sending transactions</a></li><li class="sidebar-sub-header"><a href="/chapters/14.html#delegating-contract-funds" class="sidebar-link">Delegating contract funds</a></li><li class="sidebar-sub-header"><a href="/chapters/14.html#originating-new-contracts" class="sidebar-link">Originating new contracts</a></li></ul></li><li><a href="/chapters/15.html" class="sidebar-link">Chapter 15</a></li><li><a href="/chapters/99.html" class="sidebar-link">Kernel helpers</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="chapter-14"><a href="#chapter-14" class="header-anchor">#</a> Chapter 14</h1> <p>All the use cases we have explored so far follow a very simple flow: a transaction hits the smart contract, the parameter sent with the transaction and the storage are pushed as a pair onto the stack, the code of the contract manipulates the stack with or without the help of environment variables and a pair containing a list of transactions (that was until now empty) and the new storage is returned.</p> <p>However, smart contracts on the Tezos blockchain are also able to interact with the blockchain itself. They can create and send new transactions, they can delegate their funds to bakers and they can even originate new contracts! This will be the subject of this chapter.</p> <p>The interactions between your smart contract and the blockchain allow for the creation of rich and complex applications that can run multiple actions in the background while keeping the requirement for action from your users minimal. Let's start with one of the most important ones, the creation of new transactions!</p> <h2 id="creating-and-sending-transactions"><a href="#creating-and-sending-transactions" class="header-anchor">#</a> Creating and sending transactions</h2> <p>Until now, we have always returned an empty list of transactions at the end of our smart contracts. A list of transactions, may it be empty or not, is necessary to stop the execution of a smart contract. At the end of the contract, there are two kinds of transactions you may want to send to the network: an amount of tokens to send to an implicit account or a transaction to another smart contract.<br>
It is important to remember that whatever happens inside the contract code has no effect on the blockchain. Nothing will be changed in the smart contract or the rest of blockchain before the contract returns a list of operations and its new storage. It may seem like a limitation, for example, it makes it more difficult to use data from another smart contract inside your contract, but it is actually a necessary security feature: this self-contained environment guarantees that no intervention from outside the contract can modify its storage. Your code modifies the storage without any outside influence in a very deterministic way.</p> <p>That being said, it is of course possible to interact with the Tezos blockchain from the smart contract, at the end of the execution. One of the most common interactions is sending a transaction. If you write a contract that holds people's funds, there should be a way to send them back to them! You could also write a contract that fetches some data from another contract (for example an oracle) and needs to send a transaction.</p> <p>Let's check first how sending a transaction to an implicit account looks like:</p> <div class="language-Michelson extra-class"><pre class="language-Michelson"><code class="language-Michelson"><span class="token keyword">PATCH</span><span class="token punctuation"> </span><span class="token operator">SENDER</span><span class="token punctuation"> </span><span class="token number">&quot;tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb&quot;</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">PATCH</span><span class="token punctuation"> </span><span class="token operator">BALANCE</span><span class="token punctuation"> </span><span class="token number">200</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation">
</span><span class="token keyword">parameter</span><span class="token punctuation"> </span><span class="token class-name">mutez</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">storage</span><span class="token punctuation"> </span><span class="token class-name">unit</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">code</span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">CAR</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">DUP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">BALANCE</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token variable">IFCMPLT</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation"> </span><span class="token variable">FAIL</span><span class="token punctuation"> </span><span class="token punctuation">}</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">SENDER</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">CONTRACT</span><span class="token punctuation"> </span><span class="token class-name">unit</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">IF_NONE</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation"> </span><span class="token variable">FAIL</span><span class="token punctuation"> </span><span class="token punctuation">}</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">SWAP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">UNIT</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">TRANSFER_TOKENS</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">NIL</span><span class="token punctuation"> </span><span class="token class-name">operation</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">SWAP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">CONS</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">UNIT</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">SWAP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">PAIR</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation">}</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation">}</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation">
</span><span class="token keyword">RUN</span><span class="token punctuation"> </span><span class="token attr-name">%default</span><span class="token punctuation"> </span><span class="token number">100</span><span class="token punctuation"> </span><span class="token number">Unit</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span></code></pre></div><div class="stdout"><pre><span class="stream-name">stdout</span><br>PATCH: set SENDER=tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb;
PATCH: set BALANCE=200;
parameter mutez;
storage unit;
code { CAR ; DUP ; BALANCE ; { { COMPARE ; LT } ; IF { { UNIT ; FAILWITH } } { SENDER ; CONTRACT unit ; IF_NONE { { UNIT ; FAILWITH } } { SWAP ; UNIT ; TRANSFER_TOKENS ; NIL operation ; SWAP ; CONS ; UNIT ; SWAP ; PAIR } } } };
RUN: use %default; drop all; push (100, Unit);
CAR: pop (100, Unit); push 100;
DUP: push 100;
BALANCE: push 200;
COMPARE: pop 200, 100; push 1;
LT: pop 1; push False;
IF: pop False;
SENDER: push tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb;
CONTRACT: pop tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb; skip check; push ('tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb%default',);
IF_NONE: pop ('tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb%default',); push tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb%default;
SWAP: pop tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb%default, 100; push tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb%default; push 100;
UNIT: push Unit;
TRANSFER_TOKENS: pop Unit, 100, tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb%default; set BALANCE=100; push &lt;send 100 to tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb&gt;;
NIL: push [];
SWAP: pop [], &lt;send 100 to tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb&gt;; push []; push &lt;send 100 to tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb&gt;;
CONS: pop &lt;send 100 to tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb&gt;, []; push ['&lt;send 100 to tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb&gt;'];
UNIT: push Unit;
SWAP: pop Unit, ['&lt;send 100 to tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb&gt;']; push Unit; push ['&lt;send 100 to tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb&gt;'];
PAIR: pop ['&lt;send 100 to tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb&gt;'], Unit; push (['&lt;send 100 to tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb&gt;'], Unit);</pre></div> <div class="embedded-html"><table><thead><tr><th>value                                    </th><th>type                                     </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">Unit</pre></td><td><pre style="text-align:left;">unit</pre></td></tr></tbody></table><br><table><thead><tr><th>kind                                            </th><th>target                                                                   </th><th>amount                                  </th><th>entrypoint                                  </th><th>parameters                               </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">transaction</pre></td><td><pre style="text-align:left;">tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb</pre></td><td><pre style="text-align:left;">100</pre></td><td><pre style="text-align:left;">default</pre></td><td><pre style="text-align:left;">Unit</pre></td></tr></tbody></table></div> <p>This simple smart contract takes an amount of <code>mutez</code> as a parameter, checks if the balance is greater than the requested amount and sends the amount to the sender of the transaction.</p> <p>In order to create a transaction, you need three elements in the following order on the stack:</p> <ol><li>A parameter to send with the value of type <code>contract</code></li> <li>An amount in <code>mutez</code></li> <li>A value of type <code>contract</code></li></ol> <p>This can be a bit confusing because here, we don't want to send a transaction to a contract but to an implicit account. However, implicit accounts can be seen as codeless contract. Because they don't have any code, they also don't accept any parameter or more precisely, they accept a parameter of type <code>unit</code> (because there are no <code>undefined</code> or <code>null</code> values in Michelson).</p> <p>To send a transaction to an implicit account, we will first cast an <code>address</code> into a <code>contract</code>. We can use the <strong><code>CONTRACT</code></strong> instruction with a parameter of type <code>unit</code> (because implicit accounts don't have a parameter). Remember that this instruction returns a value of type <code>option</code> so we have to use <strong><code>IF_NONE</code></strong>/<strong><code>IF_SOME</code></strong> to extract the value. When this is ready, we can add the amount in <code>mutez</code> we want to send (<code>0</code> is also acceptable, although the transaction may be invalid). Finally, we have to push a value of type <code>unit</code> on top of the previous two elements, for example with <strong><code>UNIT</code></strong>. Once the stack is ready, we can call <strong><code>TRANSFER_TOKENS</code></strong>. Although the name can be misleading, this is the instruction that will create a new transaction. Don't forget that, at this point, we have merely created the transaction and it hasn't been sent yet. The transaction will only be sent after we put it inside a list of elements of type <code>operation</code> and end the execution of the contract.</p> <p>Now, you understood the basics of sending a transaction from a smart contract, so let's see how we can do the same to send a transaction to another smart contract:</p> <div class="language-Michelson extra-class"><pre class="language-Michelson"><code class="language-Michelson"><span class="token keyword">parameter</span><span class="token punctuation"> </span><span class="token punctuation">(</span><span class="token class-name">pair</span><span class="token punctuation"> </span><span class="token punctuation">(</span><span class="token class-name">contract</span><span class="token punctuation"> </span><span class="token class-name">int</span><span class="token punctuation">)</span><span class="token punctuation"> </span><span class="token class-name">int</span><span class="token punctuation">)</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">storage</span><span class="token punctuation"> </span><span class="token class-name">unit</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">code</span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">CAR</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token variable">UNPAIR</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">SWAP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">PUSH</span><span class="token punctuation"> </span><span class="token class-name">mutez</span><span class="token punctuation"> </span><span class="token number">0</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">SWAP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">TRANSFER_TOKENS</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">NIL</span><span class="token punctuation"> </span><span class="token class-name">operation</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">SWAP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">CONS</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">UNIT</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">SWAP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">PAIR</span><span class="token punctuation">
</span><span class="token punctuation">}</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation">
</span><span class="token keyword">RUN</span><span class="token punctuation"> </span><span class="token attr-name">%default</span><span class="token punctuation"> </span><span class="token punctuation">(</span><span class="token number">Pair</span><span class="token punctuation"> </span><span class="token number">&quot;KT1FM76xKAcN8EQkZVfBmeQzjzwNtpzYVwK3%default&quot;</span><span class="token punctuation"> </span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation"> </span><span class="token number">Unit</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span></code></pre></div><div class="stdout"><pre><span class="stream-name">stdout</span><br>parameter (pair (contract int) int);
storage unit;
code { CAR ; { DUP ; CAR ; DIP { CDR } } ; SWAP ; PUSH mutez 0 ; SWAP ; TRANSFER_TOKENS ; NIL operation ; SWAP ; CONS ; UNIT ; SWAP ; PAIR };
RUN: use %default; drop all; push (('KT1FM76xKAcN8EQkZVfBmeQzjzwNtpzYVwK3%default', 4), Unit);
CAR: pop (('KT1FM76xKAcN8EQkZVfBmeQzjzwNtpzYVwK3%default', 4), Unit); push ('KT1FM76xKAcN8EQkZVfBmeQzjzwNtpzYVwK3%default', 4);
DUP: push ('KT1FM76xKAcN8EQkZVfBmeQzjzwNtpzYVwK3%default', 4);
CAR: pop ('KT1FM76xKAcN8EQkZVfBmeQzjzwNtpzYVwK3%default', 4); push KT1FM76xKAcN8EQkZVfBmeQzjzwNtpzYVwK3%default;
DIP: protect 1 item(s);
CDR: pop ('KT1FM76xKAcN8EQkZVfBmeQzjzwNtpzYVwK3%default', 4); push 4;
restore 1 item(s);
SWAP: pop KT1FM76xKAcN8EQkZVfBmeQzjzwNtpzYVwK3%default, 4; push KT1FM76xKAcN8EQkZVfBmeQzjzwNtpzYVwK3%default; push 4;
PUSH: push 0;
SWAP: pop 0, 4; push 0; push 4;
TRANSFER_TOKENS: pop 4, 0, KT1FM76xKAcN8EQkZVfBmeQzjzwNtpzYVwK3%default; set BALANCE=257000000; push &lt;call KT1FM76xKAcN8EQkZVfBmeQzjzwNtpzYVwK3%default&gt;;
NIL: push [];
SWAP: pop [], &lt;call KT1FM76xKAcN8EQkZVfBmeQzjzwNtpzYVwK3%default&gt;; push []; push &lt;call KT1FM76xKAcN8EQkZVfBmeQzjzwNtpzYVwK3%default&gt;;
CONS: pop &lt;call KT1FM76xKAcN8EQkZVfBmeQzjzwNtpzYVwK3%default&gt;, []; push ['&lt;call KT1FM76xKAcN8EQkZVfBmeQzjzwNtpzYVwK3%default&gt;'];
UNIT: push Unit;
SWAP: pop Unit, ['&lt;call KT1FM76xKAcN8EQkZVfBmeQzjzwNtpzYVwK3%default&gt;']; push Unit; push ['&lt;call KT1FM76xKAcN8EQkZVfBmeQzjzwNtpzYVwK3%default&gt;'];
PAIR: pop ['&lt;call KT1FM76xKAcN8EQkZVfBmeQzjzwNtpzYVwK3%default&gt;'], Unit; push (['&lt;call KT1FM76xKAcN8EQkZVfBmeQzjzwNtpzYVwK3%default&gt;'], Unit);</pre></div> <div class="embedded-html"><table><thead><tr><th>value                                    </th><th>type                                     </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">Unit</pre></td><td><pre style="text-align:left;">unit</pre></td></tr></tbody></table><br><table><thead><tr><th>kind                                            </th><th>target                                                                   </th><th>amount                                </th><th>entrypoint                                  </th><th>parameters                            </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">transaction</pre></td><td><pre style="text-align:left;">KT1FM76xKAcN8EQkZVfBmeQzjzwNtpzYVwK3</pre></td><td><pre style="text-align:left;">0</pre></td><td><pre style="text-align:left;">default</pre></td><td><pre style="text-align:left;">4</pre></td></tr></tbody></table></div> <p>This transaction is a little more straighforward that the previous one but follows exactly the same step, although with different values. We use an amount of <code>mutez 0</code> because we don't want to send any token to the contract but we replace the value of type <code>unit</code> with a value of type <code>int</code>. Note that although the address we send is a contract address, Michelson only sees an <code>address</code> and it must be cast to a <code>contract</code> value to process the transaction.</p> <h2 id="delegating-contract-funds"><a href="#delegating-contract-funds" class="header-anchor">#</a> Delegating contract funds</h2> <p>Like any other address on the Tezos network, contracts can delegate the funds they hold to a baker. This is very simple to implement and creates a new operation to include in the returned list of operations:</p> <div class="language-Michelson extra-class"><pre class="language-Michelson"><code class="language-Michelson"><span class="token keyword">parameter</span><span class="token punctuation"> </span><span class="token class-name">key_hash</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">storage</span><span class="token punctuation"> </span><span class="token class-name">unit</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">code</span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">CAR</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">SOME</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">SET_DELEGATE</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">NIL</span><span class="token punctuation"> </span><span class="token class-name">operation</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">SWAP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">CONS</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">UNIT</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">SWAP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">PAIR</span><span class="token punctuation">
</span><span class="token punctuation">}</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation">
</span><span class="token keyword">RUN</span><span class="token punctuation"> </span><span class="token attr-name">%default</span><span class="token punctuation"> </span><span class="token number">&quot;edpkvGfYw3LyB1UcCahKQk4rF2tvbMUk8GFiTuMjL75uGXrpvKXhjn&quot;</span><span class="token punctuation"> </span><span class="token number">Unit</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span></code></pre></div><div class="stdout"><pre><span class="stream-name">stdout</span><br>parameter key_hash;
storage unit;
code { CAR ; SOME ; SET_DELEGATE ; NIL operation ; SWAP ; CONS ; UNIT ; SWAP ; PAIR };
RUN: use %default; drop all; push ('edpkvGfYw3LyB1UcCahKQk4rF2tvbMUk8GFiTuMjL75uGXrpvKXhjn', Unit);
CAR: pop ('edpkvGfYw3LyB1UcCahKQk4rF2tvbMUk8GFiTuMjL75uGXrpvKXhjn', Unit); push edpkvGfYw3LyB1UcCahKQk4rF2tvbMUk8GFiTuMjL75uGXrpvKXhjn;
SOME: pop edpkvGfYw3LyB1UcCahKQk4rF2tvbMUk8GFiTuMjL75uGXrpvKXhjn; push ('edpkvGfYw3LyB1UcCahKQk4rF2tvbMUk8GFiTuMjL75uGXrpvKXhjn',);
SET_DELEGATE: pop ('edpkvGfYw3LyB1UcCahKQk4rF2tvbMUk8GFiTuMjL75uGXrpvKXhjn',); push &lt;delegate to edpkvGfYw3LyB1UcCahKQk4rF2tvbMUk8GFiTuMjL75uGXrpvKXhjn&gt;;
NIL: push [];
SWAP: pop [], &lt;delegate to edpkvGfYw3LyB1UcCahKQk4rF2tvbMUk8GFiTuMjL75uGXrpvKXhjn&gt;; push []; push &lt;delegate to edpkvGfYw3LyB1UcCahKQk4rF2tvbMUk8GFiTuMjL75uGXrpvKXhjn&gt;;
CONS: pop &lt;delegate to edpkvGfYw3LyB1UcCahKQk4rF2tvbMUk8GFiTuMjL75uGXrpvKXhjn&gt;, []; push ['&lt;delegate to edpkvGfYw3LyB1UcCahKQk4rF2tvbMUk8GFiTuMjL75uGXrpvKXhjn&gt;'];
UNIT: push Unit;
SWAP: pop Unit, ['&lt;delegate to edpkvGfYw3LyB1UcCahKQk4rF2tvbMUk8GFiTuMjL75uGXrpvKXhjn&gt;']; push Unit; push ['&lt;delegate to edpkvGfYw3LyB1UcCahKQk4rF2tvbMUk8GFiTuMjL75uGXrpvKXhjn&gt;'];
PAIR: pop ['&lt;delegate to edpkvGfYw3LyB1UcCahKQk4rF2tvbMUk8GFiTuMjL75uGXrpvKXhjn&gt;'], Unit; push (['&lt;delegate to edpkvGfYw3LyB1UcCahKQk4rF2tvbMUk8GFiTuMjL75uGXrpvKXhjn&gt;'], Unit);</pre></div> <div class="embedded-html"><table><thead><tr><th>value                                    </th><th>type                                     </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">Unit</pre></td><td><pre style="text-align:left;">unit</pre></td></tr></tbody></table><br><table><thead><tr><th>kind                                           </th><th>target                                                                                     </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">delegation</pre></td><td><pre style="text-align:left;">edpkvGfYw3LyB1UcCahKQk4rF2tvbMUk8GFiTuMjL75uGXrpvKXhjn</pre></td></tr></tbody></table></div> <p>The <strong><code>SET_DELEGATE</code></strong> instruction must be called with a <code>key_hash</code> wrapped in an <code>option</code> on the top of the stack. The key hash is what is generally called the &quot;public key&quot; (which is different from the &quot;public key hash&quot;).<br>
Even if the contract in the example seems to work, be aware that this operation will fail if the address you use is not a registered delegate (meaning that you cannot use any address as this is the case in this example). The operation also fails if you send the address to which the funds are already delegated. It is also possible to use <code>None</code> before calling <strong><code>SET_DELEGATE</code></strong> if you want to remove the current delegation.</p> <h2 id="originating-new-contracts"><a href="#originating-new-contracts" class="header-anchor">#</a> Originating new contracts</h2> <p>Contracts can even create new contracts or &quot;originate&quot; them in the Tezos lingo. Contracts that can originate other contracts on demand are called &quot;contract factories&quot;. Before creating a new contract, the stack must present the following elements in the given order:</p> <ol><li>The delegate address wrapped in an <code>option</code> type (or <code>None</code>)</li> <li>The initial balance you want to give to the new contract from the current contract (or <code>0</code>)</li></ol> <p>When these elements are in place on the stack, you can call <strong><code>CREATE_CONTRACT</code></strong> to originate the new contract as illustrated in the example below:</p> <div class="language-Michelson extra-class"><pre class="language-Michelson"><code class="language-Michelson"><span class="token keyword">parameter</span><span class="token punctuation"> </span><span class="token class-name">unit</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">storage</span><span class="token punctuation"> </span><span class="token class-name">unit</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">code</span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">DROP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">PUSH</span><span class="token punctuation"> </span><span class="token class-name">int</span><span class="token punctuation"> </span><span class="token number">6</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">PUSH</span><span class="token punctuation"> </span><span class="token class-name">mutez</span><span class="token punctuation"> </span><span class="token number">0</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">PUSH</span><span class="token punctuation"> </span><span class="token class-name">key_hash</span><span class="token punctuation"> </span><span class="token number">&quot;edpkvGfYw3LyB1UcCahKQk4rF2tvbMUk8GFiTuMjL75uGXrpvKXhjn&quot;</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">SOME</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">CREATE_CONTRACT</span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation"> </span><span class="token class-name">int</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation"> </span><span class="token class-name">int</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation"> </span><span class="token variable">UNPAIR</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation"> </span><span class="token operator">ADD</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation"> </span><span class="token operator">NIL</span><span class="token punctuation"> </span><span class="token class-name">operation</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation"> </span><span class="token operator">PAIR</span><span class="token punctuation"> </span><span class="token punctuation">}</span><span class="token punctuation"> </span><span class="token punctuation">}</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">NIL</span><span class="token punctuation"> </span><span class="token class-name">operation</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">SWAP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">CONS</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">DIP</span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation"> </span><span class="token operator">DROP</span><span class="token punctuation"> </span><span class="token punctuation">}</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">UNIT</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">SWAP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">PAIR</span><span class="token punctuation">
</span><span class="token punctuation">}</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation">
</span><span class="token keyword">RUN</span><span class="token punctuation"> </span><span class="token attr-name">%default</span><span class="token punctuation"> </span><span class="token number">Unit</span><span class="token punctuation"> </span><span class="token number">Unit</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span></code></pre></div><div class="stdout"><pre><span class="stream-name">stdout</span><br>parameter unit;
storage unit;
code { DROP ; PUSH int 6 ; PUSH mutez 0 ; PUSH key_hash &quot;edpkvGfYw3LyB1UcCahKQk4rF2tvbMUk8GFiTuMjL75uGXrpvKXhjn&quot; ; SOME ; CREATE_CONTRACT { int ; int ; { { DUP ; CAR ; DIP { CDR } } ; ADD ; NIL operation ; PAIR } } ; NIL operation ; SWAP ; CONS ; DIP { DROP } ; UNIT ; SWAP ; PAIR };
RUN: use %default; drop all; push (Unit, Unit);
DROP: pop (Unit, Unit);
PUSH: push 6;
PUSH: push 0;
PUSH: push edpkvGfYw3LyB1UcCahKQk4rF2tvbMUk8GFiTuMjL75uGXrpvKXhjn;
SOME: pop edpkvGfYw3LyB1UcCahKQk4rF2tvbMUk8GFiTuMjL75uGXrpvKXhjn; push ('edpkvGfYw3LyB1UcCahKQk4rF2tvbMUk8GFiTuMjL75uGXrpvKXhjn',);
CREATE_CONTRACT: pop ('edpkvGfYw3LyB1UcCahKQk4rF2tvbMUk8GFiTuMjL75uGXrpvKXhjn',), 0, 6; set BALANCE=1000000; push KT1Mjjcb6tmSsLm7Cb3DSQszePjfchPM4Uxm; push &lt;originate KT1Mjjcb6tmSsLm7Cb3DSQszePjfchPM4Uxm&gt;;
NIL: push [];
SWAP: pop [], &lt;originate KT1Mjjcb6tmSsLm7Cb3DSQszePjfchPM4Uxm&gt;; push []; push &lt;originate KT1Mjjcb6tmSsLm7Cb3DSQszePjfchPM4Uxm&gt;;
CONS: pop &lt;originate KT1Mjjcb6tmSsLm7Cb3DSQszePjfchPM4Uxm&gt;, []; push ['&lt;originate KT1Mjjcb6tmSsLm7Cb3DSQszePjfchPM4Uxm&gt;'];
DIP: protect 1 item(s);
DROP: pop KT1Mjjcb6tmSsLm7Cb3DSQszePjfchPM4Uxm;
restore 1 item(s);
UNIT: push Unit;
SWAP: pop Unit, ['&lt;originate KT1Mjjcb6tmSsLm7Cb3DSQszePjfchPM4Uxm&gt;']; push Unit; push ['&lt;originate KT1Mjjcb6tmSsLm7Cb3DSQszePjfchPM4Uxm&gt;'];
PAIR: pop ['&lt;originate KT1Mjjcb6tmSsLm7Cb3DSQszePjfchPM4Uxm&gt;'], Unit; push (['&lt;originate KT1Mjjcb6tmSsLm7Cb3DSQszePjfchPM4Uxm&gt;'], Unit);</pre></div> <div class="embedded-html"><table><thead><tr><th>value                                    </th><th>type                                     </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">Unit</pre></td><td><pre style="text-align:left;">unit</pre></td></tr></tbody></table><br><table><thead><tr><th>kind                                            </th><th>target                                                                   </th><th>amount                                </th><th>storage                               </th><th>code                                                                                             </th><th>delegate                                                                                   </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">origination</pre></td><td><pre style="text-align:left;">KT1Mjjcb6tmSsLm7Cb3DSQszePjfchPM4Uxm</pre></td><td><pre style="text-align:left;">0</pre></td><td><pre style="text-align:left;">6</pre></td><td><pre style="text-align:left;">{ { DUP ; CAR ; DIP { CDR } } ; ADD ; NIL operation ; PAIR }</pre></td><td><pre style="text-align:left;">edpkvGfYw3LyB1UcCahKQk4rF2tvbMUk8GFiTuMjL75uGXrpvKXhjn</pre></td></tr></tbody></table></div> <p>As you can tell from the contract, once all the arguments are in the correct position in the stack, you can call the <strong><code>CREATE_CONTRACT</code></strong> instruction which takes one argument: the code of the contract it will originate. Between curly braces, you must start with the type of the storage, before the type of the parameter and finally the code of the contract itself. <strong><code>CREATE_CONTRACT</code></strong> returns a new operation that you must include in the list of operations to be executed at the end of the current contract and the address of the newly created contract.</p> <div id="bottom-right-wrapper" class="fab-wrapper" style="right:5vw;bottom:4vh;z-index:999;position:fixed;" data-v-f9cfe6e4><div id="bottom-right-action" class="actions-container" style="bottom:-20px;padding-bottom:20px;" data-v-f9cfe6e4><ul class="fab-list" style="display:none;" data-v-f9cfe6e4 data-v-f9cfe6e4><!----><!----></ul></div> <div class="fab-main pointer" style="background-color:#c6b29b;padding:28px;" data-v-f9cfe6e4><i class="md-24 material-icons main" data-v-f9cfe6e4>add</i> <i class="md-24 material-icons close" data-v-f9cfe6e4>add</i></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/chapters/13.html" class="prev">
        Chapter 13
      </a></span> <span class="next"><a href="/chapters/15.html">
        Chapter 15
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.18800d3b.js" defer></script><script src="/assets/js/2.430b66b2.js" defer></script><script src="/assets/js/23.cfbbd282.js" defer></script><script src="/assets/js/4.c279c943.js" defer></script><script src="/assets/js/3.550cb5aa.js" defer></script>
  </body>
</html>
