<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Chapter 5 | Michelson Labs</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon.png">
    <meta name="description" content="In this new installment of our tutorials, we are going to talk about money!  ">
    <meta name="image" content="https://michelson.baking-bad.org/og.png">
    <meta name="twitter:title" content="Chapter 5">
    <meta name="twitter:description" content="In this new installment of our tutorials, we are going to talk about money!  ">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://michelson.baking-bad.org/og.png">
    <meta name="twitter:url" content="https://michelson.baking-bad.org/chapters/05.html">
    <meta name="twitter:site" content="@TezosBakingBad">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Chapter 5">
    <meta property="og:description" content="In this new installment of our tutorials, we are going to talk about money!  ">
    <meta property="og:image" content="https://michelson.baking-bad.org/og.png">
    <meta property="og:url" content="https://michelson.baking-bad.org/chapters/05.html">
    <meta property="og:site_name" content="Michelson Labs">
    <meta itemprop="name" content="Chapter 5">
    <meta itemprop="description" content="In this new installment of our tutorials, we are going to talk about money!  ">
    <meta itemprop="image" content="https://michelson.baking-bad.org/og.png">
    <link rel="preload" href="/assets/css/0.styles.923b5b72.css" as="style"><link rel="preload" href="/assets/js/app.ce1eeaed.js" as="script"><link rel="preload" href="/assets/js/2.430b66b2.js" as="script"><link rel="preload" href="/assets/js/14.2277b277.js" as="script"><link rel="preload" href="/assets/js/4.c279c943.js" as="script"><link rel="preload" href="/assets/js/3.550cb5aa.js" as="script"><link rel="prefetch" href="/assets/js/10.0d5736c5.js"><link rel="prefetch" href="/assets/js/11.55ca987f.js"><link rel="prefetch" href="/assets/js/12.fd9e6b5c.js"><link rel="prefetch" href="/assets/js/13.3bce631e.js"><link rel="prefetch" href="/assets/js/15.eb0c7b73.js"><link rel="prefetch" href="/assets/js/16.2de2534a.js"><link rel="prefetch" href="/assets/js/17.7a334c23.js"><link rel="prefetch" href="/assets/js/18.851e2510.js"><link rel="prefetch" href="/assets/js/19.8edfcad7.js"><link rel="prefetch" href="/assets/js/20.36f33ce0.js"><link rel="prefetch" href="/assets/js/21.f1a05d41.js"><link rel="prefetch" href="/assets/js/22.ae6a8509.js"><link rel="prefetch" href="/assets/js/23.382d2ae2.js"><link rel="prefetch" href="/assets/js/24.28616269.js"><link rel="prefetch" href="/assets/js/5.d5783f99.js"><link rel="prefetch" href="/assets/js/6.cb0bbb2c.js"><link rel="prefetch" href="/assets/js/7.16d6fa11.js"><link rel="prefetch" href="/assets/js/8.c7c848cc.js"><link rel="prefetch" href="/assets/js/9.d1dbceb8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.923b5b72.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="Michelson Labs" class="logo"> <span class="site-name can-hide">Michelson Labs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/learn.html" class="nav-link">
  Learn
</a></div><div class="nav-item"><a href="/introduction.html" class="nav-link">
  Notebooks 
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/learn.html" class="nav-link">
  Learn
</a></div><div class="nav-item"><a href="/introduction.html" class="nav-link">
  Notebooks 
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/learn.html" class="sidebar-link">Learn Michelson</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn.html#why-ðŸ¤”" class="sidebar-link">Why ðŸ¤”</a></li><li class="sidebar-sub-header"><a href="/learn.html#how" class="sidebar-link">How</a></li><li class="sidebar-sub-header"><a href="/learn.html#resources" class="sidebar-link">Resources</a></li><li class="sidebar-sub-header"><a href="/learn.html#contact-us" class="sidebar-link">Contact us</a></li><li class="sidebar-sub-header"><a href="/learn.html#about" class="sidebar-link">About</a></li></ul></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Notebooks</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/introduction.html" class="sidebar-link">Introduction</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/introduction.html#try-online" class="sidebar-link">Try online</a></li><li class="sidebar-sub-header"><a href="/introduction.html#run-in-docker" class="sidebar-link">Run in Docker</a></li><li class="sidebar-sub-header"><a href="/introduction.html#install-jupyter" class="sidebar-link">Install Jupyter</a></li><li class="sidebar-sub-header"><a href="/introduction.html#notebook-workflow" class="sidebar-link">Notebook workflow</a></li></ul></li><li><a href="/chapters/01.html" class="sidebar-link">Chapter 1</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapters/01.html#understanding-the-stack" class="sidebar-link">Understanding the stack</a></li><li class="sidebar-sub-header"><a href="/chapters/01.html#structure-of-a-smart-contract" class="sidebar-link">Structure of a Smart Contract</a></li><li class="sidebar-sub-header"><a href="/chapters/01.html#operation-codes" class="sidebar-link">Operation codes</a></li><li class="sidebar-sub-header"><a href="/chapters/01.html#running-the-contract-step-by-step" class="sidebar-link">Running the contract step-by-step</a></li></ul></li><li><a href="/chapters/02.html" class="sidebar-link">Chapter 2</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapters/02.html#types-in-michelson" class="sidebar-link">Types in Michelson</a></li><li class="sidebar-sub-header"><a href="/chapters/02.html#advanced-stack-usage" class="sidebar-link">Advanced stack usage</a></li></ul></li><li><a href="/chapters/03.html" class="sidebar-link">Chapter 3</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapters/03.html#compare-and-generic-comparisons" class="sidebar-link">Compare and generic comparisons</a></li><li class="sidebar-sub-header"><a href="/chapters/03.html#conditionals" class="sidebar-link">Conditionals</a></li><li class="sidebar-sub-header"><a href="/chapters/03.html#fail-and-assert" class="sidebar-link">FAIL and ASSERT</a></li><li class="sidebar-sub-header"><a href="/chapters/03.html#recap" class="sidebar-link">Recap</a></li></ul></li><li><a href="/chapters/04.html" class="sidebar-link">Chapter 4</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapters/04.html#available-types-for-arithmetic-operations" class="sidebar-link">Available types for arithmetic operations</a></li><li class="sidebar-sub-header"><a href="/chapters/04.html#the-add-instruction" class="sidebar-link">The `ADD` instruction</a></li><li class="sidebar-sub-header"><a href="/chapters/04.html#the-sub-instruction" class="sidebar-link">The `SUB` instruction</a></li><li class="sidebar-sub-header"><a href="/chapters/04.html#the-mul-instruction" class="sidebar-link">The `MUL` instruction</a></li><li class="sidebar-sub-header"><a href="/chapters/04.html#the-ediv-instruction" class="sidebar-link">The `EDIV` instruction</a></li><li class="sidebar-sub-header"><a href="/chapters/04.html#other-operations-on-numeric-values" class="sidebar-link">Other operations on numeric values</a></li></ul></li><li><a href="/chapters/05.html" aria-current="page" class="active sidebar-link">Chapter 5</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapters/05.html#mutez-and-mutez-operations" class="sidebar-link">mutez and mutez operations</a></li><li class="sidebar-sub-header"><a href="/chapters/05.html#balance-amount-and-now" class="sidebar-link">`BALANCE`, `AMOUNT` and `NOW`</a></li><li class="sidebar-sub-header"><a href="/chapters/05.html#address-contract-and-token-transfer" class="sidebar-link">Address, contract and token transfer</a></li></ul></li><li><a href="/chapters/06.html" class="sidebar-link">Chapter 6</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapters/06.html#boolean-type-and-operations-on-booleans" class="sidebar-link">Boolean type and operations on booleans</a></li><li class="sidebar-sub-header"><a href="/chapters/06.html#cryptographic-operations" class="sidebar-link">Cryptographic operations</a></li></ul></li><li><a href="/chapters/07.html" class="sidebar-link">Chapter 7</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapters/07.html#strings-and-string-manipulations" class="sidebar-link">Strings and string manipulations</a></li><li class="sidebar-sub-header"><a href="/chapters/07.html#working-with-lists" class="sidebar-link">Working with lists</a></li></ul></li><li><a href="/chapters/08.html" class="sidebar-link">Chapter 8</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapters/08.html#overview-of-the-pair-type" class="sidebar-link">Overview of the pair type</a></li><li class="sidebar-sub-header"><a href="/chapters/08.html#operations-on-pairs" class="sidebar-link">Operations on pairs</a></li><li class="sidebar-sub-header"><a href="/chapters/08.html#pairing-and-unpairing" class="sidebar-link">Pairing and unpairing</a></li></ul></li><li><a href="/chapters/09.html" class="sidebar-link">Chapter 9</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapters/09.html#casting-types" class="sidebar-link">Casting types</a></li><li class="sidebar-sub-header"><a href="/chapters/09.html#working-with-bytes" class="sidebar-link">Working with bytes</a></li></ul></li><li><a href="/chapters/10.html" class="sidebar-link">Chapter 10</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapters/10.html#working-with-sets" class="sidebar-link">Working with sets</a></li><li class="sidebar-sub-header"><a href="/chapters/10.html#working-with-maps" class="sidebar-link">Working with maps</a></li></ul></li><li><a href="/chapters/11.html" class="sidebar-link">Chapter 11</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapters/11.html#the-loop-instruction" class="sidebar-link">The `LOOP` instruction</a></li><li class="sidebar-sub-header"><a href="/chapters/11.html#iterating-on-sets" class="sidebar-link">Iterating on sets</a></li><li class="sidebar-sub-header"><a href="/chapters/11.html#iterating-on-maps" class="sidebar-link">Iterating on maps</a></li></ul></li><li><a href="/chapters/12.html" class="sidebar-link">Chapter 12</a></li><li><a href="/chapters/13.html" class="sidebar-link">Chapter 13</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapters/13.html#address-and-contract-types" class="sidebar-link">Address and contract types</a></li><li class="sidebar-sub-header"><a href="/chapters/13.html#self-source-and-sender" class="sidebar-link">SELF, SOURCE and SENDER</a></li></ul></li><li><a href="/chapters/14.html" class="sidebar-link">Chapter 14</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapters/14.html#creating-and-sending-transactions" class="sidebar-link">Creating and sending transactions</a></li><li class="sidebar-sub-header"><a href="/chapters/14.html#delegating-contract-funds" class="sidebar-link">Delegating contract funds</a></li><li class="sidebar-sub-header"><a href="/chapters/14.html#originating-new-contracts" class="sidebar-link">Originating new contracts</a></li></ul></li><li><a href="/chapters/99.html" class="sidebar-link">Kernel helpers</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="chapter-5"><a href="#chapter-5" class="header-anchor">#</a> Chapter 5</h1> <p>In this new installment of our tutorials, we are going to talk about money!<br>
One of the main advantages of smart contracts is that they are &quot;programmable money&quot;: they let you store, manipulate and send tezzies in a predictable way. Smart contracts can work as middle men and verify that a set of conditions is met before initiating a transaction, sending a certain amount of tezzies or doing any other modification.</p> <p>In the previous tutorials, we encountered a couple of instructions that push useful information about the smart contract and its context onto the stack: you may remember <strong><code>NOW</code></strong> that adds the current timestamp on top of the stack. This is not the only one. Michelson provides a few instructions that give you access to a lot of information. In this chapter, we are going to focus on the ones that are related to the financial aspect of smart contracts: <strong><code>BALANCE</code></strong>, <strong><code>AMOUNT</code></strong>, <strong><code>TRANFER_TOKENS</code></strong>. You will also get a refresher about <code>mutez</code> operations. At the end of the chapter, you will have everything you need to know in order to handle financial operations in your smart contracts ðŸ¤‘</p> <h3 id="plan-of-the-tutorial"><a href="#plan-of-the-tutorial" class="header-anchor">#</a> Plan of the tutorial</h3> <ol><li><a href="#section1" style="text-decoration:none;"><code>mutez</code> and <code>mutez</code> operations</a></li> <li><a href="#section2" style="text-decoration:none;"><strong><code>BALANCE</code></strong>, <strong><code>AMOUNT</code></strong> and <strong><code>NOW</code></strong></a></li> <li><a href="#section3" style="text-decoration:none;">Address, contract and token transfer</a></li></ol> <p><span id="section1"></span></p> <h2 id="mutez-and-mutez-operations"><a href="#mutez-and-mutez-operations" class="header-anchor">#</a> <code>mutez</code> and <code>mutez</code> operations</h2> <p>The <code>mutez</code> (or <em>micro-tez</em>) type is a special type that allows you to manipulate financial values in your smart contracts. <code>mutez</code> are indivisible and always positive (as exposed below, a few restrictions are set to avoid negative values of <code>mutez</code>). It may seem a little strange at the beginning, but <code>mutez</code> values are NOT tezzies, they only represent a financial value. If you write <code>PUSH mutez 1000</code>, this doesn't mean you added 1,000 microtez out of thin air in your smart contract. You merely create a value of a certain type to easily manipulate other values.</p> <p>You can use different arithmetic operations for values of type <code>mutez</code>: <strong><code>ADD</code></strong>, <strong><code>SUB</code></strong>, <strong><code>MUL</code></strong>, <strong><code>EDIV</code></strong> with a few restrictions:</p> <ul><li><strong><code>ADD</code></strong> only works with two values of type <code>mutez</code></li> <li><strong><code>SUB</code></strong> only works with two values of type <code>mutez</code> AND fails if the result of the subtraction is negative</li> <li><strong><code>MUL</code></strong> only works with one value of type <code>mutez</code> and one value of type <code>nat</code>, the result is of type <code>mutez</code></li> <li><strong><code>EDIV</code></strong> only works with one value of type <code>mutez</code> and one value of type <code>nat</code>, the result is of type <code>option</code>, <code>None</code> in case of a division by zero, <code>Some ((pair quotient remainder))</code> including a pair containing the quotient on the left and the remainder on the right</li></ul> <p>In addition to these operations, it is also possible to compare two values of type <code>mutez</code>. Like any other value, this comparison yields an <code>int</code> between <code>-1</code> and <code>1</code>.</p> <p>Now let's see some examples:</p> <p>We initialize a simple contract to test these operations:</p> <div class="language-Michelson extra-class"><pre class="language-Michelson"><code class="language-Michelson"><span class="token keyword">storage</span><span class="token punctuation"> </span><span class="token class-name">mutez</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">parameter</span><span class="token punctuation"> </span><span class="token class-name">unit</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">BEGIN</span><span class="token punctuation"> </span><span class="token number">Unit</span><span class="token punctuation"> </span><span class="token number">1000</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span></code></pre></div><div class="stdout"><pre><span class="stream-name">stdout</span><br>storage mutez;
parameter unit;
BEGIN: use %default; drop all; push (Unit, 1000);</pre></div> <div class="embedded-html"><table><thead><tr><th>value                                              </th><th>type                                                </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">Pair Unit 1000</pre></td><td><pre style="text-align:left;">pair unit mutez</pre></td></tr></tbody></table></div> <p>Now let's separate the storage and push a new value of type <code>mutez</code> (nothing new here):</p> <div class="language-Michelson extra-class"><pre class="language-Michelson"><code class="language-Michelson"><span class="token operator">CDR</span><span class="token punctuation"> </span><span class="token attr-name">@storage</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token operator">PUSH</span><span class="token punctuation"> </span><span class="token class-name">mutez</span><span class="token punctuation"> </span><span class="token number">2000</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">DUMP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span></code></pre></div><div class="stdout"><pre><span class="stream-name">stdout</span><br>CDR: pop (Unit, 1000); push 1000;
PUSH: push 2000;</pre></div> <div class="embedded-html"><table><thead><tr><th>value                                    </th><th>type                                      </th><th>name                                         </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">2000</pre></td><td><pre style="text-align:left;">mutez</pre></td><td></td></tr> <tr><td><pre style="text-align:left;">1000</pre></td><td><pre style="text-align:left;">mutez</pre></td><td><pre style="text-align:left;">@storage</pre></td></tr></tbody></table></div> <p>With the <strong><code>ADD</code></strong> instruction, we can remove the two values of type <code>mutez</code> from the stack, add them together and push the result back to the stack:</p> <div class="language-Michelson extra-class"><pre class="language-Michelson"><code class="language-Michelson"><span class="token operator">ADD</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span></code></pre></div><div class="embedded-html"><table><thead><tr><th>value                                    </th><th>type                                      </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">3000</pre></td><td><pre style="text-align:left;">mutez</pre></td></tr></tbody></table></div> <p>After adding values together, let's try to subtract one from another! We push a new value of type <code>mutez</code> and use the one already present in the stack to demonstrate <strong><code>SUB</code></strong>:</p> <div class="language-Michelson extra-class"><pre class="language-Michelson"><code class="language-Michelson"><span class="token operator">PUSH</span><span class="token punctuation"> </span><span class="token class-name">mutez</span><span class="token punctuation"> </span><span class="token number">500</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token operator">SWAP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token operator">SUB</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span></code></pre></div><div class="stdout"><pre><span class="stream-name">stdout</span><br>PUSH: push 500;
SWAP: pop 500, 3000; push 500; push 3000;
SUB: pop 3000, 500; push 2500;</pre></div> <div class="embedded-html"><table><thead><tr><th>value                                    </th><th>type                                      </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">2500</pre></td><td><pre style="text-align:left;">mutez</pre></td></tr></tbody></table></div> <p>Did you notice the <strong><code>SWAP</code></strong> instruction? You must make sure that the two elements are in the right order. If you try <code>mutez 500 - mutez 3000</code>, the contract will fail because <code>mutez</code> values cannot be negative.</p> <p>Next, we can multiply <code>mutez</code> values with <code>nat</code> values (to ensure positive results). In this situation, the order of the values doesn't matter, so no need to swap them:</p> <div class="language-Michelson extra-class"><pre class="language-Michelson"><code class="language-Michelson"><span class="token operator">PUSH</span><span class="token punctuation"> </span><span class="token class-name">nat</span><span class="token punctuation"> </span><span class="token number">4</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token operator">MUL</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span></code></pre></div><div class="stdout"><pre><span class="stream-name">stdout</span><br>PUSH: push 4;
MUL: pop 4, 2500; push 10000;</pre></div> <div class="embedded-html"><table><thead><tr><th>value                                     </th><th>type                                      </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">10000</pre></td><td><pre style="text-align:left;">mutez</pre></td></tr></tbody></table></div> <p>As you can see, the value returned by <strong><code>MUL</code></strong> is also of type <code>mutez</code>.</p> <p>As it was the case for the other numeric values, using <strong><code>EDIV</code></strong> with <code>mutez</code> is also a bit more complex. If you remember from the previous chapter, the result of <strong><code>EDIV</code></strong> is an option. If you try a division by zero, the option will have the value <code>None</code>. Otherwise, it has a value of type <code>pair</code> that contains the quotient on the left and the remainder on the right.</p> <p>We can write a small piece of code that tries to divide the value on top of the stack by the value we've just pushed. If this value is <code>0</code>, the contract fails. Otherwise, it extracts the quotient and the remainder and rearrange them in this order in the stack:</p> <div class="language-Michelson extra-class"><pre class="language-Michelson"><code class="language-Michelson"><span class="token operator">PUSH</span><span class="token punctuation"> </span><span class="token class-name">nat</span><span class="token punctuation"> </span><span class="token number">10</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token operator">SWAP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token operator">EDIV</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token operator">IF_NONE</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation"> </span><span class="token operator">PUSH</span><span class="token punctuation"> </span><span class="token class-name">string</span><span class="token punctuation"> </span><span class="token number">&quot;DivisionByZero&quot;</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation"> </span><span class="token operator">FAILWITH</span><span class="token punctuation"> </span><span class="token punctuation">}</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">DUP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">CAR</span><span class="token punctuation"> </span><span class="token attr-name">@quotient</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">SWAP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">CDR</span><span class="token punctuation"> </span><span class="token attr-name">@remainder</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">SWAP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation">}</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">DUMP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span></code></pre></div><div class="stdout"><pre><span class="stream-name">stdout</span><br>PUSH: push 10;
SWAP: pop 10, 10000; push 10; push 10000;
EDIV: pop 10000, 10; push ((1000, 0),);
IF_NONE: pop ((1000, 0),); push (1000, 0);
  DUP: push (1000, 0);
  CAR: pop (1000, 0); push 1000;
  SWAP: pop 1000, (1000, 0); push 1000; push (1000, 0);
  CDR: pop (1000, 0); push 0;
  SWAP: pop 0, 1000; push 0; push 1000;</pre></div> <div class="embedded-html"><table><thead><tr><th>value                                    </th><th>type                                      </th><th>name                                           </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">1000</pre></td><td><pre style="text-align:left;">mutez</pre></td><td><pre style="text-align:left;">@quotient</pre></td></tr> <tr><td><pre style="text-align:left;">0</pre></td><td><pre style="text-align:left;">mutez</pre></td><td><pre style="text-align:left;">@remainder</pre></td></tr></tbody></table></div> <p>The two values we get on the stack are exactly the expected ones: <code>10000 / 10 = 1000</code> with a remainder of <code>0</code>.</p> <p>Lastly, we can compare two values of type <code>mutez</code> and check if one is equal, greater or less than the other one. This will be particularly useful when you want to verify that users send the correct amount of tezzies required by your contract:</p> <div class="language-Michelson extra-class"><pre class="language-Michelson"><code class="language-Michelson"><span class="token operator">PUSH</span><span class="token punctuation"> </span><span class="token class-name">mutez</span><span class="token punctuation"> </span><span class="token number">500</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token operator">COMPARE</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token operator">EQ</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span></code></pre></div><div class="stdout"><pre><span class="stream-name">stdout</span><br>PUSH: push 500;
COMPARE: pop 500, 1000; push -1;
EQ: pop -1; push False;</pre></div> <div class="embedded-html"><table><thead><tr><th>value                                     </th><th>type                                     </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">False</pre></td><td><pre style="text-align:left;">bool</pre></td></tr></tbody></table></div> <p>We're adding here an extra step to check if the newly added value in the stack is equal to the one already present. As they are not equal, <code>False</code> is pushed onto the stack. Obviously, you can use any of the instructions we studied in Chapter three outside of <strong><code>EQ</code></strong>.</p> <p><span id="section2"></span></p> <h2 id="balance-amount-and-now"><a href="#balance-amount-and-now" class="header-anchor">#</a> <strong><code>BALANCE</code></strong>, <strong><code>AMOUNT</code></strong> and <strong><code>NOW</code></strong></h2> <p>Michelson provides a few instructions that are very useful to check the context of execution.</p> <p>Every time a smart contract runs, a few &quot;variables&quot; are available about data related to the current execution. For example, every transaction sent to a smart contract has an amount of tezzies attached to it (even if this is amount may be <code>0</code>). You may want to have access to this amount, for example, to check if the users sent enough tezzies for the service they requested or to update their token balance.<br>
You can easily add this piece of information to the stack by using <strong><code>AMOUNT</code></strong>. The <strong><code>AMOUNT</code></strong> instruction will simply push a new element on top of the stack of type <code>mutez</code> whose value is equal to the amount sent along the transaction.</p> <p>Here are two examples to showcase what you can do with the <strong><code>AMOUNT</code></strong> instruction:</p> <div class="language-Michelson extra-class"><pre class="language-Michelson"><code class="language-Michelson"><span class="token keyword">storage</span><span class="token punctuation"> </span><span class="token class-name">mutez</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">parameter</span><span class="token punctuation"> </span><span class="token class-name">unit</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">code</span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">CDR</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">AMOUNT</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">DUP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">DUG</span><span class="token punctuation"> </span><span class="token number">2</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token variable">IFCMPGT</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation"> </span><span class="token operator">NIL</span><span class="token punctuation"> </span><span class="token class-name">operation</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation"> </span><span class="token operator">PAIR</span><span class="token punctuation"> </span><span class="token punctuation">}</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation"> </span><span class="token variable">FAIL</span><span class="token punctuation"> </span><span class="token punctuation">}</span><span class="token punctuation">
</span><span class="token punctuation">}</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation">
</span><span class="token keyword">RUN</span><span class="token punctuation"> </span><span class="token attr-name">%default</span><span class="token punctuation"> </span><span class="token number">Unit</span><span class="token punctuation"> </span><span class="token number">100</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span></code></pre></div><div class="stdout"><pre><span class="stream-name">stdout</span><br>storage mutez;
parameter unit;
code { CDR ; AMOUNT ; DUP ; DUG 2 ; { { COMPARE ; GT } ; IF { NIL operation ; PAIR } { { UNIT ; FAILWITH } } } };
RUN: use %default; drop all; push (Unit, 100);
CDR: pop (Unit, 100); push 100;
AMOUNT: push 0;
DUP: push 0;
DUG: pop 0; protect 2 item(s); push 0; restore 2 item(s);
COMPARE: pop 0, 100; push -1;
GT: pop -1; push False;
IF: pop False;
UNIT: push Unit;
FAILWITH: pop Unit;</pre></div> <div class="stderr"><pre><span class="stream-name">stderr</span><br>MichelsonRuntimeError: Unit
at RUN -&gt; IF -&gt; FAILWITH</pre></div> <p>The contract fails as expected. Indeed, there is no tezzie attached to this transaction, so the value contained in <strong><code>AMOUNT</code></strong> is not greater than the one in the storage.<br>
Because this environment is detached from the blockchain, you have to specify yourself the value you want to give to <code>amount</code> and use a non-Michelson instruction that works only in the context of these notebooks: <strong><code>PATCH</code></strong>. Here is how it works:</p> <div class="language-Michelson extra-class"><pre class="language-Michelson"><code class="language-Michelson"><span class="token keyword">storage</span><span class="token punctuation"> </span><span class="token class-name">mutez</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">parameter</span><span class="token punctuation"> </span><span class="token class-name">unit</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">code</span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token keyword">PATCH</span><span class="token punctuation"> </span><span class="token operator">AMOUNT</span><span class="token punctuation"> </span><span class="token number">200</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">CDR</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">AMOUNT</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">DUP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">DUG</span><span class="token punctuation"> </span><span class="token number">2</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token variable">IFCMPGT</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation"> </span><span class="token operator">NIL</span><span class="token punctuation"> </span><span class="token class-name">operation</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation"> </span><span class="token operator">PAIR</span><span class="token punctuation"> </span><span class="token punctuation">}</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation"> </span><span class="token variable">FAIL</span><span class="token punctuation"> </span><span class="token punctuation">}</span><span class="token punctuation">
</span><span class="token punctuation">}</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation">
</span><span class="token keyword">RUN</span><span class="token punctuation"> </span><span class="token attr-name">%default</span><span class="token punctuation"> </span><span class="token number">Unit</span><span class="token punctuation"> </span><span class="token number">100</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span></code></pre></div><div class="stdout"><pre><span class="stream-name">stdout</span><br>storage mutez;
parameter unit;
code { PATCH AMOUNT 200 ; CDR ; AMOUNT ; DUP ; DUG 2 ; { { COMPARE ; GT } ; IF { NIL operation ; PAIR } { { UNIT ; FAILWITH } } } };
RUN: use %default; drop all; push (Unit, 100);
PATCH: set AMOUNT=200;
CDR: pop (Unit, 100); push 100;
AMOUNT: push 200;
DUP: push 200;
DUG: pop 200; protect 2 item(s); push 200; restore 2 item(s);
COMPARE: pop 200, 100; push 1;
GT: pop 1; push True;
IF: pop True;
NIL: push [];
PAIR: pop [], 200; push ([], 200);</pre></div> <div class="embedded-html"><table><thead><tr><th>value                                   </th><th>type                                      </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">200</pre></td><td><pre style="text-align:left;">mutez</pre></td></tr></tbody></table></div> <p>You can see that the newly returned storage is <code>mutez 200</code> as expected, because <code>200</code> is greater than <code>100</code>.</p> <p>Other scenario: you create a smart contract and you want to prevent people from sending any tezzie. To do so, you must check if the amount is equal to <code>0</code> before proceeding and if it is not the case, the contract fails:</p> <div class="language-Michelson extra-class"><pre class="language-Michelson"><code class="language-Michelson"><span class="token keyword">storage</span><span class="token punctuation"> </span><span class="token class-name">mutez</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">parameter</span><span class="token punctuation"> </span><span class="token class-name">unit</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">code</span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token keyword">PATCH</span><span class="token punctuation"> </span><span class="token operator">AMOUNT</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">DROP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">AMOUNT</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">PUSH</span><span class="token punctuation"> </span><span class="token class-name">mutez</span><span class="token punctuation"> </span><span class="token number">0</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token variable">IFCMPNEQ</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation"> </span><span class="token variable">FAIL</span><span class="token punctuation"> </span><span class="token punctuation">}</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation"> </span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">AMOUNT</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">NIL</span><span class="token punctuation"> </span><span class="token class-name">operation</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">PAIR</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation">}</span><span class="token punctuation">
</span><span class="token punctuation">}</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation">
</span><span class="token keyword">RUN</span><span class="token punctuation"> </span><span class="token attr-name">%default</span><span class="token punctuation"> </span><span class="token number">Unit</span><span class="token punctuation"> </span><span class="token number">100</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span></code></pre></div><div class="stdout"><pre><span class="stream-name">stdout</span><br>storage mutez;
parameter unit;
code { PATCH AMOUNT ; DROP ; AMOUNT ; PUSH mutez 0 ; { { COMPARE ; NEQ } ; IF { { UNIT ; FAILWITH } } { AMOUNT ; NIL operation ; PAIR } } };
RUN: use %default; drop all; push (Unit, 100);
PATCH: unset AMOUNT;
DROP: pop (Unit, 100);
AMOUNT: push 0;
PUSH: push 0;
COMPARE: pop 0, 0; push 0;
NEQ: pop 0; push False;
IF: pop False;
AMOUNT: push 0;
NIL: push [];
PAIR: pop [], 0; push ([], 0);</pre></div> <div class="embedded-html"><table><thead><tr><th>value                                 </th><th>type                                      </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">0</pre></td><td><pre style="text-align:left;">mutez</pre></td></tr></tbody></table></div> <p>You can also use <code>PATCH AMOUNT</code> with no value, which will be <code>0</code> by default. We then use the <strong><code>IFCMPNEQ</code></strong> instruction to check if the value on top of the stack (the <code>0</code> we pushed just before) is not equal to the one below (the amount). Be careful to push a value of type <code>mutez</code> for the comparison.<br>
If the result of the comparison is true (i.e the amount is not equal to <code>0</code>), the contract fails. Otherwise, we pushed the amount again (remember that every instruction starting with <strong><code>IF</code></strong> removes the value(s) on top of the stack) and end the execution by saving the amount in the storage.</p> <div class="custom-block warning"><p class="custom-block-title">NOTE</p> <p>in a real-life scenario, you wouldn't need to push <strong><code>AMOUNT</code></strong> again if you expect the amount to be equal to <code>0</code>, you can go with <code>PUSH mutez 0</code> instead. The example above demonstrates that you have access to the value in mutez attached to the transaction at every step of the execution of the contract.</p></div> <p>In some cases, you would like to know the current balance of the contract before running a piece of code. For example, one of your users requests to withdraw his/her share in the smart contract and you need to make sure there are enough funds before initiating the transaction. You may also want to block entering transactions if the balance of the contract reaches a certain limit.</p> <p>In these cases, you can use <strong><code>BALANCE</code></strong>. Just like <strong><code>AMOUNT</code></strong>, <strong><code>BALANCE</code></strong> is an instruction that pushes a new value on top of the stack containing the current balance of the smart contract in <code>mutez</code>.</p> <p>Let's write a smart contract that keeps track in the storage of the last transaction sent after making sure the current balance doesn't exceed a certain limit:</p> <div class="language-Michelson extra-class"><pre class="language-Michelson"><code class="language-Michelson"><span class="token keyword">storage</span><span class="token punctuation"> </span><span class="token class-name">mutez</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">parameter</span><span class="token punctuation"> </span><span class="token class-name">unit</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">code</span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">DROP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token keyword">PATCH</span><span class="token punctuation"> </span><span class="token operator">AMOUNT</span><span class="token punctuation"> </span><span class="token number">10000000</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation"> </span><span class="token comment">## manual setting of amount</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token keyword">PATCH</span><span class="token punctuation"> </span><span class="token operator">BALANCE</span><span class="token punctuation"> </span><span class="token number">25700000</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation"> </span><span class="token comment">## manual setting of balance</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">AMOUNT</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">BALANCE</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">ADD</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">DUP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">PUSH</span><span class="token punctuation"> </span><span class="token class-name">mutez</span><span class="token punctuation"> </span><span class="token number">100000000</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation"> </span><span class="token comment"># 100 tez</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token variable">IFCMPGT</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation"> </span><span class="token operator">NIL</span><span class="token punctuation"> </span><span class="token class-name">operation</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation"> </span><span class="token operator">PAIR</span><span class="token punctuation"> </span><span class="token punctuation">}</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation"> </span><span class="token operator">PUSH</span><span class="token punctuation"> </span><span class="token class-name">string</span><span class="token punctuation"> </span><span class="token number">&quot;BalanceExceeded&quot;</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation"> </span><span class="token operator">FAILWITH</span><span class="token punctuation"> </span><span class="token punctuation">}</span><span class="token punctuation">
</span><span class="token punctuation">}</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation">
</span><span class="token keyword">RUN</span><span class="token punctuation"> </span><span class="token attr-name">%default</span><span class="token punctuation"> </span><span class="token number">Unit</span><span class="token punctuation"> </span><span class="token number">1000</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span></code></pre></div><div class="stdout"><pre><span class="stream-name">stdout</span><br>storage mutez;
parameter unit;
code { DROP ; PATCH AMOUNT 10000000 ; PATCH BALANCE 25700000 ; AMOUNT ; BALANCE ; ADD ; DUP ; PUSH mutez 100000000 ; { { COMPARE ; GT } ; IF { NIL operation ; PAIR } { PUSH string &quot;BalanceExceeded&quot; ; FAILWITH } } };
RUN: use %default; drop all; push (Unit, 1000);
DROP: pop (Unit, 1000);
PATCH: set AMOUNT=10000000;
PATCH: set BALANCE=25700000;
AMOUNT: push 10000000;
BALANCE: push 25700000;
ADD: pop 25700000, 10000000; push 35700000;
DUP: push 35700000;
PUSH: push 100000000;
COMPARE: pop 100000000, 35700000; push 1;
GT: pop 1; push True;
IF: pop True;
NIL: push [];
PAIR: pop [], 35700000; push ([], 35700000);</pre></div> <div class="embedded-html"><table><thead><tr><th>value                                        </th><th>type                                      </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">35700000</pre></td><td><pre style="text-align:left;">mutez</pre></td></tr></tbody></table></div> <p>This is a very simple smart contract that does one simple thing: it adds the incoming amount to the balance, compares the result with the limit we manually introduce (with <code>PUSH mutez 100000000 ;</code>), if the limit is greater than the addition of the amount and the balance, everything is fine, we save the amount in the storage and end the execution. However, if the limit is exceeded, we throw an error with the <strong><code>FAIL</code></strong> instruction.</p> <p>If you try to change the values (for example adding a <code>0</code> to the balance), you can make the contract fail to test that it works properly.</p> <p>We already introduced <strong><code>NOW</code></strong> in the previous chapters. The instruction pushes the current timestamp onto the stack. This is a very useful feature for time-related actions: for example, we can make a smart contract fail if a transaction comes before a certain period ended since the last transaction:</p> <div class="language-Michelson extra-class"><pre class="language-Michelson"><code class="language-Michelson"><span class="token keyword">storage</span><span class="token punctuation"> </span><span class="token class-name">timestamp</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">parameter</span><span class="token punctuation"> </span><span class="token class-name">unit</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">code</span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">CDR</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">PUSH</span><span class="token punctuation"> </span><span class="token class-name">int</span><span class="token punctuation"> </span><span class="token number">3600</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation"> </span><span class="token comment">## 60 sec * 60 min = 1 hour interval</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">ADD</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token keyword">PATCH</span><span class="token punctuation"> </span><span class="token operator">NOW</span><span class="token punctuation"> </span><span class="token number">1592381823</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">NOW</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token variable">IFCMPGE</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation"> </span><span class="token operator">NOW</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation"> </span><span class="token operator">NIL</span><span class="token punctuation"> </span><span class="token class-name">operation</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation"> </span><span class="token operator">PAIR</span><span class="token punctuation"> </span><span class="token punctuation">}</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation"> </span><span class="token operator">PUSH</span><span class="token punctuation"> </span><span class="token class-name">string</span><span class="token punctuation"> </span><span class="token number">&quot;InvalidInterval&quot;</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation"> </span><span class="token operator">FAILWITH</span><span class="token punctuation"> </span><span class="token punctuation">}</span><span class="token punctuation">
</span><span class="token punctuation">}</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation">
</span><span class="token keyword">RUN</span><span class="token punctuation"> </span><span class="token attr-name">%default</span><span class="token punctuation"> </span><span class="token number">Unit</span><span class="token punctuation"> </span><span class="token number">1592379223</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span></code></pre></div><div class="stdout"><pre><span class="stream-name">stdout</span><br>storage timestamp;
parameter unit;
code { CDR ; PUSH int 3600 ; ADD ; NOW ; { { COMPARE ; GE } ; IF { NOW ; NIL operation ; PAIR } { PUSH string &quot;InvalidInterval&quot; ; FAILWITH } } };
RUN: use %default; drop all; push (Unit, 1592379223);
CDR: pop (Unit, 1592379223); push 1592379223;
PUSH: push 3600;
ADD: pop 3600, 1592379223; push 1592382823;
NOW: push 1592456946;
COMPARE: pop 1592456946, 1592382823; push 1;
GE: pop 1; push True;
IF: pop True;
NOW: push 1592456946;
NIL: push [];
PAIR: pop [], 1592456946; push ([], 1592456946);</pre></div> <div class="embedded-html"><table><thead><tr><th>value                                          </th><th>type                                          </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">1592456946</pre></td><td><pre style="text-align:left;">timestamp</pre></td></tr></tbody></table></div> <p>As you can see, the contract stores the timestamp of the last successful execution. When a transaction comes, it adds 3,600 seconds to that timestamp and compares it to the current timestamp. If one hour has passed, the new timestamp is saved into the storage. Otherwise, an error is raised and the contract fails.</p> <p>In the contract, we use <code>PATCH NOW 1592381823</code> in order to force a certain value for our <strong><code>NOW</code></strong> instruction and see the contract fail. If you comment out this line (just add <code>##</code> at the very beginning of the line) and run the contract again, you can see that it passes now, because there is more than one hour between <code>NOW</code> and the timestamp in the storage. The value returned by <strong><code>NOW</code></strong> is then saved into the storage.</p> <p><span id="section3"></span></p> <h2 id="address-contract-and-token-transfer"><a href="#address-contract-and-token-transfer" class="header-anchor">#</a> Address, contract and token transfer</h2> <p>One of the many features of smart contracts is their ability to transfer money. You can send tezzies to a smart contract, you can send them from the smart contract to an address and you can even exchange tezzies between smart contracts! You can let anyone transfer money in and out but you can also enforce certain rules that dictate who can make transfers and how these transfers can happen. After reading this section, you will know everything you need to manage tezzies in your smart contracts!</p> <p>Let's start from the beginning, with the <code>address</code> type. <code>address</code> is a type in Michelson reserved for addresses. It can be used both for implicit account (starting with <em>tz1</em>, <em>tz2</em> or <em>tz3</em>) and smart contract (starting with <em>KT1</em>) addresses. You can type an address as a string when you want, for example, to add it onto the stack:</p> <div class="language-Michelson extra-class"><pre class="language-Michelson"><code class="language-Michelson"><span class="token keyword">storage</span><span class="token punctuation"> </span><span class="token class-name">address</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">parameter</span><span class="token punctuation"> </span><span class="token class-name">unit</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">code</span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">DROP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">PUSH</span><span class="token punctuation"> </span><span class="token class-name">address</span><span class="token punctuation"> </span><span class="token number">&quot;tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb&quot;</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">NIL</span><span class="token punctuation"> </span><span class="token class-name">operation</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">PAIR</span><span class="token punctuation">
</span><span class="token punctuation">}</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation">
</span><span class="token keyword">RUN</span><span class="token punctuation"> </span><span class="token attr-name">%default</span><span class="token punctuation"> </span><span class="token number">Unit</span><span class="token punctuation"> </span><span class="token number">&quot;&quot;</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span></code></pre></div><div class="stdout"><pre><span class="stream-name">stdout</span><br>storage address;
parameter unit;
code { DROP ; PUSH address &quot;tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb&quot; ; NIL operation ; PAIR };
RUN: use %default; drop all; push (Unit, '');
DROP: pop (Unit, '');
PUSH: push tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb;
NIL: push [];
PAIR: pop [], tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb; push ([], 'tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb');</pre></div> <div class="embedded-html"><table><thead><tr><th>value                                                                      </th><th>type                                        </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">&quot;tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb&quot;</pre></td><td><pre style="text-align:left;">address</pre></td></tr></tbody></table></div> <p>Be aware that the <code>address</code> type does not ensure that the address is a valid address, only that the string follows the address format.</p> <p>If you want to ensure that the address is valid, you can use the <code>contract (param)</code> type. This type guarantees that the address is a valid, existing account with a parameter of type <code>param</code>. In case of an implicit account, <code>param</code> is equal to <code>unit</code>. As it is impossible to &quot;push&quot; a value of type <code>contract</code> onto the stack, you have to start with a value of type <code>address</code> and cast it to a value of type <code>contract</code>. Let's see an example before detailing what happens:</p> <div class="language-Michelson extra-class"><pre class="language-Michelson"><code class="language-Michelson"><span class="token keyword">storage</span><span class="token punctuation"> </span><span class="token punctuation">(</span><span class="token class-name">contract</span><span class="token punctuation"> </span><span class="token class-name">unit</span><span class="token punctuation">)</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">parameter</span><span class="token punctuation"> </span><span class="token class-name">unit</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">code</span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">DROP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">PUSH</span><span class="token punctuation"> </span><span class="token class-name">address</span><span class="token punctuation"> </span><span class="token number">&quot;tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb&quot;</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">CONTRACT</span><span class="token punctuation"> </span><span class="token class-name">unit</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token operator">IF_NONE</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation"> </span><span class="token variable">FAIL</span><span class="token punctuation"> </span><span class="token punctuation">}</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation"> </span><span class="token operator">NIL</span><span class="token punctuation"> </span><span class="token class-name">operation</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation"> </span><span class="token operator">PAIR</span><span class="token punctuation"> </span><span class="token punctuation">}</span><span class="token punctuation">
</span><span class="token punctuation">}</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token punctuation">
</span><span class="token keyword">RUN</span><span class="token punctuation"> </span><span class="token attr-name">%default</span><span class="token punctuation"> </span><span class="token number">Unit</span><span class="token punctuation"> </span><span class="token number">&quot;&quot;</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span></code></pre></div><div class="stdout"><pre><span class="stream-name">stdout</span><br>storage (contract unit);
parameter unit;
code { DROP ; PUSH address &quot;tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb&quot; ; CONTRACT unit ; IF_NONE { { UNIT ; FAILWITH } } { NIL operation ; PAIR } };
RUN: use %default; drop all; push (Unit, '');
DROP: pop (Unit, '');
PUSH: push tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb;
CONTRACT: pop tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb; skip check; push ('tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb%default',);
IF_NONE: pop ('tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb%default',); push tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb%default;
NIL: push [];
PAIR: pop [], tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb%default; push ([], 'tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb%default');</pre></div> <div class="embedded-html"><table><thead><tr><th>value                                                                              </th><th>type                                              </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">&quot;tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb%default&quot;</pre></td><td><pre style="text-align:left;">contract unit</pre></td></tr></tbody></table></div> <p>In this example, we convert a value of type <code>address</code> to a value of type <code>contract</code> and save the result in the storage. Several steps are necessary to achieve it:</p> <ol><li>We remove the first element of the stack with <strong><code>DROP</code></strong>.</li> <li>We add the address on top of the stack with <strong><code>PUSH</code></strong>.</li> <li>We use a special instruction called <strong><code>CONTRACT</code></strong> to cast the address to a contract value. Note that we provide a parameter of type <code>unit</code> indicating that the resulting value will be an implicit account.</li> <li>Two things may happen at this point: if the address is invalid or doesn't exist, <strong><code>CONTRACT</code></strong> returns the value <code>None</code> of type option. We can use it to make the contract fail. If the address is valid and exists, <strong><code>CONTRACT</code></strong> returns the value <code>(Some (contract param))</code> of type option that we unwrap in the second branch of the conditional structure to get the value of type <code>(contract unit)</code>. This value is then saved in the storage.</li></ol> <p>In a real-life scenario, you wouldn't probably go through all these steps just to save the result in the storage. This operation can be particularly useful when you want to send tokens from a contract. Michelson provides an instruction that allows you to withdraw tezzies from the contract balance and send them to an implicit account or another contract: <strong><code>TRANSFER_TOKENS</code></strong>. The use of this instruction is not difficult by itself but you have to make sure to get its necessary parameters in the right order in the stack before calling it. Let's see an example first to observe what <strong><code>TRANSFER_TOKENS</code></strong> does:</p> <div class="language-Michelson extra-class"><pre class="language-Michelson"><code class="language-Michelson"><span class="token keyword">storage</span><span class="token punctuation"> </span><span class="token class-name">unit</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">parameter</span><span class="token punctuation"> </span><span class="token class-name">unit</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">BEGIN</span><span class="token punctuation"> </span><span class="token number">Unit</span><span class="token punctuation"> </span><span class="token number">Unit</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">PATCH</span><span class="token punctuation"> </span><span class="token operator">BALANCE</span><span class="token punctuation"> </span><span class="token number">10000000</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token operator">DROP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span></code></pre></div><div class="stdout"><pre><span class="stream-name">stdout</span><br>storage unit;
parameter unit;
BEGIN: use %default; drop all; push (Unit, Unit);
PATCH: set BALANCE=10000000;
DROP: pop (Unit, Unit);</pre></div> <p>This initializes the storage and the parameter before dropping the first element of the stack. We also add 10 tez to the balance so we have something to send to the receiver's address.</p> <div class="language-Michelson extra-class"><pre class="language-Michelson"><code class="language-Michelson"><span class="token operator">PUSH</span><span class="token punctuation"> </span><span class="token class-name">address</span><span class="token punctuation"> </span><span class="token number">&quot;tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb&quot;</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token operator">CONTRACT</span><span class="token punctuation"> </span><span class="token class-name">unit</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">DUMP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span></code></pre></div><div class="stdout"><pre><span class="stream-name">stdout</span><br>PUSH: push tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb;
CONTRACT: pop tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb; skip check; push ('tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb%default',);</pre></div> <div class="embedded-html"><table><thead><tr><th>value                                                                                   </th><th>type                                                       </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">Some &quot;tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb%default&quot;</pre></td><td><pre style="text-align:left;">option (contract unit)</pre></td></tr></tbody></table></div> <p>Like in the previous contract, we push the receiver's address to the stack and convert it to a <code>(contract unit)</code> type.</p> <div class="language-Michelson extra-class"><pre class="language-Michelson"><code class="language-Michelson"><span class="token operator">IF_NONE</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation"> </span><span class="token operator">PUSH</span><span class="token punctuation"> </span><span class="token class-name">string</span><span class="token punctuation"> </span><span class="token number">&quot;InvalidAddress&quot;</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation"> </span><span class="token operator">FAILWITH</span><span class="token punctuation"> </span><span class="token punctuation">}</span><span class="token punctuation">
</span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation"> </span><span class="token punctuation">{</span><span class="token punctuation"> </span><span class="token punctuation">}</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">DUMP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span></code></pre></div><div class="embedded-html"><table><thead><tr><th>value                                                                              </th><th>type                                              </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">&quot;tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb%default&quot;</pre></td><td><pre style="text-align:left;">contract unit</pre></td></tr></tbody></table></div> <p><strong><code>IF_NONE</code></strong> verifies that the <strong><code>CONTRACT</code></strong> instruction succeeded and that a value has been returned. In this case, the value is the address where we will send the tezzies, of type <code>(contract unit)</code>.</p> <div class="language-Michelson extra-class"><pre class="language-Michelson"><code class="language-Michelson"><span class="token operator">PUSH</span><span class="token punctuation"> </span><span class="token class-name">mutez</span><span class="token punctuation"> </span><span class="token number">5000000</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">DUMP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span></code></pre></div><div class="embedded-html"><table><thead><tr><th>value                                                                              </th><th>type                                              </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">5000000</pre></td><td><pre style="text-align:left;">mutez</pre></td></tr> <tr><td><pre style="text-align:left;">&quot;tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb%default&quot;</pre></td><td><pre style="text-align:left;">contract unit</pre></td></tr></tbody></table></div> <p>We then push the amount we want to send to the receiver's address.</p> <div class="language-Michelson extra-class"><pre class="language-Michelson"><code class="language-Michelson"><span class="token operator">PUSH</span><span class="token punctuation"> </span><span class="token class-name">unit</span><span class="token punctuation"> </span><span class="token number">Unit</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">DUMP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span></code></pre></div><div class="embedded-html"><table><thead><tr><th>value                                                                              </th><th>type                                              </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">Unit</pre></td><td><pre style="text-align:left;">unit</pre></td></tr> <tr><td><pre style="text-align:left;">5000000</pre></td><td><pre style="text-align:left;">mutez</pre></td></tr> <tr><td><pre style="text-align:left;">&quot;tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb%default&quot;</pre></td><td><pre style="text-align:left;">contract unit</pre></td></tr></tbody></table></div> <p>Because we are sending an amount to an implicit account, the expected parameter of the value of type <code>(contract unit)</code> is <code>unit</code>, so we just need to provide an element of type <code>unit</code> to the <strong><code>TRANFER_TOKENS</code></strong> instruction.<br>
Note that the three parameters necessary to transfer tokens are now on top of the stack and in the right order:</p> <ol><li>The parameter expected for the address (<code>unit</code> for implicit accounts)</li> <li>The amount to be sent in <code>mutez</code></li> <li>The receiver's address converted to a value of type <code>(contract param)</code></li></ol> <div class="language-Michelson extra-class"><pre class="language-Michelson"><code class="language-Michelson"><span class="token operator">TRANSFER_TOKENS</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">DUMP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span></code></pre></div><div class="embedded-html"><table><thead><tr><th>value  </th><th>type                                          </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">amount: '5000000'
entrypoint: default
kind: transaction
parameters: Unit
target: tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb</pre></td><td><pre style="text-align:left;">operation</pre></td></tr></tbody></table></div> <p>Calling the <strong><code>TRANSFER_TOKENS</code></strong> instruction forges a new operation. Remember that contract executions in Michelson are self-contained: they do not communicate with the outside. The execution goes from its beginning to its end and only then it is possible to send new transactions.<br>
You can see that the value we now have on top of the stack is of type <code>operation</code> and contains all the information we previously added to the stack: the amount to be sent, the entrypoint to call (<code>default</code> by default or in case of a transaction to an implicit account), the operation kind, the parameters (<code>unit</code> for transactions to implicit accounts) and the target address. The only thing left now is to add this operation to the list of operations returned at the end of the contract.</p> <div class="language-Michelson extra-class"><pre class="language-Michelson"><code class="language-Michelson"><span class="token operator">NIL</span><span class="token punctuation"> </span><span class="token class-name">operation</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token operator">SWAP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token operator">CONS</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">DUMP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span></code></pre></div><div class="stdout"><pre><span class="stream-name">stdout</span><br>NIL: push [];
SWAP: pop [], &lt;send 5000000 to tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb&gt;; push []; push &lt;send 5000000 to tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb&gt;;
CONS: pop &lt;send 5000000 to tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb&gt;, []; push ['&lt;send 5000000 to tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb&gt;'];</pre></div> <div class="embedded-html"><table><thead><tr><th>value  </th><th>type                                               </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">- amount: '5000000'
  entrypoint: default
  kind: transaction
  parameters: Unit
  target: tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb</pre></td><td><pre style="text-align:left;">list operation</pre></td></tr></tbody></table></div> <p>Are you excited about finally using that list of operations we have been returning empty so far? ðŸ˜…</p> <p>In order to include the operation into the list of operations, you add an empty list as usual with <code>NIL operation</code>, you use <strong><code>SWAP</code></strong> because the element to add to the list must be just above in the stack and you call the <strong><code>CONS</code></strong> instruction which prepends the value to the list. Now you can return the pair with the list of operations and the storage:</p> <div class="language-Michelson extra-class"><pre class="language-Michelson"><code class="language-Michelson"><span class="token operator">UNIT</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token operator">SWAP</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token operator">PAIR</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span><span class="token keyword">COMMIT</span><span class="token punctuation"> </span><span class="token punctuation">;</span><span class="token punctuation">
</span></code></pre></div><div class="stdout"><pre><span class="stream-name">stdout</span><br>UNIT: push Unit;
SWAP: pop Unit, ['&lt;send 5000000 to tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb&gt;']; push Unit; push ['&lt;send 5000000 to tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb&gt;'];
PAIR: pop ['&lt;send 5000000 to tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb&gt;'], Unit; push (['&lt;send 5000000 to tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb&gt;'], Unit);
COMMIT:</pre></div> <div class="embedded-html"><table><thead><tr><th>value                                    </th><th>type                                     </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">Unit</pre></td><td><pre style="text-align:left;">unit</pre></td></tr></tbody></table><br><table><thead><tr><th>kind                                            </th><th>target                                                                   </th><th>amount                                      </th><th>entrypoint                                  </th><th>parameters                               </th></tr></thead> <tbody><tr><td><pre style="text-align:left;">transaction</pre></td><td><pre style="text-align:left;">tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb</pre></td><td><pre style="text-align:left;">5000000</pre></td><td><pre style="text-align:left;">default</pre></td><td><pre style="text-align:left;">Unit</pre></td></tr></tbody></table></div> <p>Nothing groundbreaking here, we push a new <code>unit</code> on top of the stack, we use <strong><code>SWAP</code></strong> because the list of operations must be on the left of the pair and then <strong><code>PAIR</code></strong>.</p> <div id="bottom-right-wrapper" class="fab-wrapper" style="right:5vw;bottom:4vh;z-index:999;position:fixed;" data-v-f9cfe6e4><div id="bottom-right-action" class="actions-container" style="bottom:-20px;padding-bottom:20px;" data-v-f9cfe6e4><ul class="fab-list" style="display:none;" data-v-f9cfe6e4 data-v-f9cfe6e4><!----><!----></ul></div> <div class="fab-main pointer" style="background-color:#c6b29b;padding:28px;" data-v-f9cfe6e4><i class="md-24 material-icons main" data-v-f9cfe6e4>add</i> <i class="md-24 material-icons close" data-v-f9cfe6e4>add</i></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/chapters/04.html" class="prev">
        Chapter 4
      </a></span> <span class="next"><a href="/chapters/06.html">
        Chapter 6
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ce1eeaed.js" defer></script><script src="/assets/js/2.430b66b2.js" defer></script><script src="/assets/js/14.2277b277.js" defer></script><script src="/assets/js/4.c279c943.js" defer></script><script src="/assets/js/3.550cb5aa.js" defer></script>
  </body>
</html>
